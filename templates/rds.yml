AWSTemplateFormatVersion: 2010-09-09
Description: An example CloudFormation template for Fargate.
# Parameters:





Resources:

  myDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties: 
      DBSubnetGroupDescription: Private subnet for RDS
    
      SubnetIds: 
        - Fn::ImportValue: PrivateSubnet1  #private                      ################################################
        - Fn::ImportValue: PrivateSubnet2
      Tags: 
        - Key: Name
          Value: DB subnet

  DBinstance: 
    Type: AWS::RDS::DBInstance
    Properties: 
      DBSubnetGroupName: !Ref myDBSubnetGroup
      AllocatedStorage: 5
      DBInstanceClass: db.t3.small
      Engine: MySQL
      MasterUsername: spring
      MasterUserPassword: spring123
      DBName: bootexample
    DeletionPolicy: Snapshot
    
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Access to the RDS instance
      VpcId:
        Fn::ImportValue: VPC
      

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Access to the ECS containers
      VpcId:
        Fn::ImportValue: VPC

  DBSecurityGroupIngressFromECS:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      Description: Ingress from the ECS containers to the RDS instance
      GroupId: !Ref 'DBSecurityGroup'
      IpProtocol: -1 
      SourceSecurityGroupId: !Ref 'ECSSecurityGroup'

#   DbSecurityByEC2SecurityGroup: 
#     Type: AWS::RDS::DBSecurityGroup
#     Properties: 
      
#       GroupDescription: "Ingress for Amazon EC2 security group"
#       DBSecurityGroupIngress: 
#           CIDRIP: 0.0.0.0/0



 

Outputs:
  DBName:
    Description: Database-password
    Value: bootexample
    Export:
      Name: dbname

  DBUsername:
    Description: Database-password
    Value: spring
    Export:
      Name: dbusername

  DBPassword:
    Description: Database-password
    Value: spring123
    Export:
      Name: dbpassword

  DBEndpoint:
    Description: The connection endpoint for the database.
    Value: !GetAtt  DBinstance.Endpoint.Address
    Export:
      Name: DBEndPoint 
